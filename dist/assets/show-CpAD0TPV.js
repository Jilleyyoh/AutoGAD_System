import{r as m,R as q,j as e,H as Y,L as B,a as F}from"./app-DZrL6wO1.js";import{A as G}from"./app-layout-BVNqvqA6.js";import{c as s,t}from"./theme-classes-C1o5LvBg.js";import{C as J}from"./chevron-left-DLBjlG0X.js";import{C as K}from"./circle-check-BkHVpkJp.js";import{c as W}from"./createLucideIcon-DkMGSA4v.js";import{S as X}from"./send-CrFCt5kN.js";import"./app-CSLFruQT.js";import"./utils-CNSwpjVw.js";import"./button-Cr4sDpjN.js";import"./index-hSTZO9jP.js";import"./index-D4D1kMjY.js";import"./index-CYBwx7kR.js";import"./x-FRcdCJN5.js";import"./index-BNxELNJL.js";/**
 * @license lucide-react v0.475.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Z=[["path",{d:"M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z",key:"1c8476"}],["path",{d:"M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7",key:"1ydtos"}],["path",{d:"M7 3v4a1 1 0 0 0 1 1h7",key:"t51u73"}]],ee=W("Save",Z),se=(i,d)=>{const o=["No","Partly","Yes"];if(!d||d.length===0)return o[0];const h=Array.from(new Set(d)).sort((b,g)=>b-g).indexOf(i);return h===0?o[0]:h===1?o[1]:h===2?o[2]:o[0]};function fe({project:i,evaluation:d,categories:o,documents:k,interpretations:h,questionnaire_version:b,version_integrity:g}){const[y,D]=m.useState("info"),[j,R]=m.useState({}),[w,T]=m.useState({}),[_,L]=m.useState(d.final_remarks||""),[A,P]=m.useState("approve"),[S,E]=m.useState(!1),[C,M]=m.useState(!1),[$,u]=m.useState(null),[x]=m.useState(d.is_completed);q.useEffect(()=>{const a={},r={};o.forEach(n=>{n.items.forEach(l=>{l.current_score!==null&&(a[l.id]=l.current_score),l.remarks&&(r[l.id]=l.remarks)})}),R(a),T(r)},[o]);const H=m.useMemo(()=>{const a={};return o.forEach(r=>{const n=r.items.reduce((l,c)=>l+(j[c.id]??0),0);a[r.id]={total:n,max:r.max_score,exceeded:n>r.max_score}}),a},[j,o]),N=m.useMemo(()=>d.total_score!==null&&d.total_score!==void 0?parseFloat(String(d.total_score)):0,[d.total_score]),v=m.useMemo(()=>h.find(a=>N>=a.min&&N<=a.max),[N,h]),V=(a,r)=>{if(x)return;let n=null,l=null;for(const p of o){const f=p.items.find(U=>U.id===a);if(f){n=p,l=f;break}}if(!l||!n)return;const c=n.items.reduce((p,f)=>f.id===a?p+(r??0):p+(j[f.id]??0),0);if(c>n.max_score){u({type:"error",text:`Cannot exceed maximum score of ${n.max_score} for ${n.name}. Current: ${c}`}),setTimeout(()=>u(null),4e3);return}R(p=>({...p,[a]:r}))},z=(a,r)=>{x||T(n=>({...n,[a]:r}))},I=async()=>{E(!0);try{const a=o.flatMap(r=>r.items).map(r=>({item_id:r.id,score:j[r.id]??null,remarks:w[r.id]??""}));await F.post(`/evaluator/evaluations/${i.id}/save`,{scores:a,final_remarks:_}),u({type:"success",text:"Evaluation saved successfully!"}),setTimeout(()=>u(null),3e3)}catch(a){const r=a.response?.data?.message||"Failed to save evaluation";a.response?.status===403&&/completed/i.test(r)?(u({type:"error",text:r}),setTimeout(()=>window.location.reload(),1200)):u({type:"error",text:r})}finally{E(!1)}},O=async()=>{if(confirm("Are you sure you want to submit this evaluation? You will not be able to edit it afterwards.")){M(!0);try{const a=o.flatMap(r=>r.items).map(r=>({item_id:r.id,score:j[r.id]??null,remarks:w[r.id]??""}));await F.post(`/evaluator/evaluations/${i.id}/save`,{scores:a,final_remarks:_}),await F.post(`/evaluator/evaluations/${i.id}/submit`,{final_action:A}),u({type:"success",text:"Evaluation submitted successfully!"}),setTimeout(()=>{window.location.href="/evaluator/evaluations"},1200)}catch(a){const r=a.response?.data?.message||"Failed to submit evaluation";a.response?.status===403&&/completed/i.test(r)?(u({type:"error",text:r}),setTimeout(()=>window.location.reload(),1200)):u({type:"error",text:r})}finally{M(!1)}}},Q=[{id:"info",label:"Project Info"},{id:"documents",label:"Documents"},{id:"questionnaire",label:"Questionnaire"},{id:"result",label:"Evaluation Result"}];return e.jsxs(G,{children:[e.jsx(Y,{title:`Evaluate: ${i.project_code}`}),e.jsx("div",{className:"max-w-7xl mx-auto py-6 sm:px-6 lg:px-8",children:e.jsxs("div",{className:s("px-4 py-6 sm:px-0",t.text.primary),children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(B,{href:"/evaluator/evaluations",className:s("p-2 rounded-lg transition-colors","hover:bg-gray-100 dark:hover:bg-slate-700"),children:e.jsx(J,{className:"w-6 h-6"})}),e.jsxs("div",{children:[e.jsx("h1",{className:s("text-3xl font-bold",t.text.primary),children:i.project_code}),e.jsx("p",{className:t.text.secondary,children:i.title})]})]}),e.jsxs("div",{className:s("border rounded-lg p-4 min-w-max",t.card.base,"bg-blue-50 dark:bg-blue-900/40 border-blue-200 dark:border-blue-800"),children:[e.jsx("p",{className:s("text-sm mb-1",t.text.secondary),children:"Total Score"}),e.jsx("p",{className:"text-3xl font-bold text-blue-600 dark:text-blue-400",children:N.toFixed(2)}),v&&e.jsx("p",{className:s("text-sm mt-2",t.text.secondary),children:v.interpretation})]})]}),b&&e.jsxs("div",{className:s("mb-6 p-3 rounded-lg border text-sm",t.card.base,"bg-amber-50 dark:bg-amber-900/30 border-amber-200 dark:border-amber-800"),children:[e.jsxs("p",{className:s("font-medium",t.text.primary),children:["Using Questionnaire Version ",b.version_number]}),e.jsx("p",{className:t.text.secondary,children:new Date(b.created_at).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"})}),b.description&&e.jsx("p",{className:s("text-xs mt-1",t.text.tertiary),children:b.description})]}),g&&g.snapshot_integrity&&e.jsxs("div",{className:s("mb-6 p-3 rounded-lg border text-xs",t.card.base,"bg-blue-50 dark:bg-blue-900/30 border-blue-200 dark:border-blue-800"),children:[e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:s("font-medium",t.text.tertiary),children:"Categories"}),e.jsx("p",{className:s("font-semibold",t.text.primary),children:g.categories_count})]}),e.jsxs("div",{children:[e.jsx("p",{className:s("font-medium",t.text.tertiary),children:"Questions"}),e.jsx("p",{className:s("font-semibold",t.text.primary),children:g.questions_count})]}),e.jsxs("div",{children:[e.jsx("p",{className:s("font-medium",t.text.tertiary),children:"Max Score"}),e.jsx("p",{className:s("font-semibold",t.text.primary),children:g.total_max_score.toFixed(2)})]}),e.jsxs("div",{children:[e.jsx("p",{className:s("font-medium",t.text.tertiary),children:"Status"}),e.jsx("p",{className:s("font-semibold",t.text.primary),children:e.jsx("span",{className:"inline-block px-2 py-1 rounded text-xs bg-green-100 dark:bg-green-900/40 text-green-800 dark:text-green-200",children:"✓ Locked"})})]})]}),e.jsxs("p",{className:s("text-xs mt-2",t.text.tertiary),children:["This evaluation is version-locked to questionnaire ",b?.version_number,". The configuration shown below cannot be modified and reflects Admin 1's exact design."]})]}),i.status==="review"&&i.admin2_remarks&&e.jsx("div",{className:s("mb-6 p-4 rounded-lg border",t.card.base,"bg-amber-50 dark:bg-amber-900/30 border-amber-200 dark:border-amber-800"),children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"flex-shrink-0 mt-0.5",children:e.jsx("div",{className:"flex items-center justify-center h-6 w-6 rounded-full bg-amber-100 dark:bg-amber-900/50",children:e.jsx("span",{className:"text-amber-600 dark:text-amber-400 font-semibold text-sm",children:"!"})})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h3",{className:s("text-sm font-semibold",t.text.primary),children:"Admin2 Feedback for Review"}),e.jsx("p",{className:s("mt-2 text-sm whitespace-pre-wrap",t.text.secondary),children:i.admin2_remarks})]})]})}),$&&e.jsx("div",{className:`mb-4 p-4 rounded-lg border ${$.type==="success"?s("",t.alert.success):s("",t.alert.error)}`,children:$.text}),e.jsx("div",{className:s("mb-6 border-b",t.border.primary),children:e.jsx("div",{className:"flex space-x-8",children:Q.map(a=>e.jsx("button",{onClick:()=>D(a.id),className:`py-3 px-1 border-b-2 font-medium text-sm transition-colors ${y===a.id?"border-blue-500 text-blue-600 dark:text-blue-400":s("border-transparent",t.text.tertiary,"hover:text-gray-700 dark:hover:text-gray-300")}`,children:a.label},a.id))})}),e.jsxs("div",{className:s("rounded-lg shadow",t.card.base),children:[y==="info"&&e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx("p",{className:s("text-sm font-medium",t.text.tertiary),children:"Project Code"}),e.jsx("p",{className:s("mt-1 text-lg font-mono",t.text.primary),children:i.project_code})]}),e.jsxs("div",{children:[e.jsx("p",{className:s("text-sm font-medium",t.text.tertiary),children:"Status"}),e.jsx("p",{className:s("mt-1 text-lg",t.text.primary),children:i.status})]}),i.certificate?.can_download&&e.jsxs("div",{children:[e.jsx("p",{className:s("text-sm font-medium",t.text.tertiary),children:"Certificate"}),e.jsx("a",{href:i.certificate.download_route,className:s("inline-flex items-center gap-2 px-3 py-2 rounded",t.link.primary),children:"Download Certificate"}),i.certificate.issued_date&&e.jsxs("p",{className:s("text-xs mt-1",t.text.tertiary),children:["Issued: ",i.certificate.issued_date]})]}),e.jsxs("div",{children:[e.jsx("p",{className:s("text-sm font-medium",t.text.tertiary),children:"Organization"}),e.jsx("p",{className:s("mt-1 text-lg",t.text.primary),children:i.organization})]}),e.jsxs("div",{children:[e.jsx("p",{className:s("text-sm font-medium",t.text.tertiary),children:"Proponent"}),e.jsx("p",{className:s("mt-1 text-lg",t.text.primary),children:i.proponent_name})]}),e.jsxs("div",{children:[e.jsx("p",{className:s("text-sm font-medium",t.text.tertiary),children:"Domain"}),e.jsx("p",{className:s("mt-1 text-lg",t.text.primary),children:i.domain})]}),e.jsxs("div",{children:[e.jsx("p",{className:s("text-sm font-medium",t.text.tertiary),children:"Phase"}),e.jsx("p",{className:s("mt-1 text-lg",t.text.primary),children:i.phase})]})]}),e.jsxs("div",{children:[e.jsx("p",{className:s("text-sm font-medium",t.text.tertiary),children:"Title"}),e.jsx("p",{className:s("mt-2",t.text.primary),children:i.title})]}),i.description&&e.jsxs("div",{children:[e.jsx("p",{className:s("text-sm font-medium",t.text.tertiary),children:"Description"}),e.jsx("p",{className:s("mt-2 whitespace-pre-wrap",t.text.secondary),children:i.description})]}),i.rationale&&e.jsxs("div",{children:[e.jsx("p",{className:s("text-sm font-medium",t.text.tertiary),children:"Rationale"}),e.jsx("p",{className:s("mt-2 whitespace-pre-wrap",t.text.secondary),children:i.rationale})]}),i.objectives&&e.jsxs("div",{children:[e.jsx("p",{className:s("text-sm font-medium",t.text.tertiary),children:"Objectives"}),e.jsx("p",{className:s("mt-2 whitespace-pre-wrap",t.text.secondary),children:i.objectives})]})]}),y==="documents"&&e.jsx("div",{className:"p-6",children:k.length>0?e.jsx("div",{className:"space-y-4",children:k.map(a=>e.jsxs("div",{className:s("flex items-start gap-4 p-4 border rounded-lg",t.border.primary,"hover:bg-gray-50 dark:hover:bg-slate-700"),children:[e.jsxs("div",{className:"flex-grow",children:[e.jsx("h3",{className:s("font-semibold",t.text.primary),children:a.file_name}),e.jsx("p",{className:s("text-sm mt-1",t.text.secondary),children:a.document_type}),a.description&&e.jsx("p",{className:s("text-sm mt-2",t.text.secondary),children:a.description}),e.jsxs("p",{className:s("text-xs mt-2",t.text.muted),children:["Uploaded: ",a.upload_date]})]}),e.jsxs("div",{className:"flex gap-2",children:[a.drive_link&&e.jsx("a",{href:a.drive_link,target:"_blank",rel:"noopener noreferrer",className:s("px-3 py-2 text-sm font-medium rounded",t.link.primary),children:"View"}),a.file_path&&e.jsx("a",{href:`/evaluator/evaluations/download/${a.id}`,className:s("px-3 py-2 text-sm font-medium rounded",t.link.primary),children:"Download"})]})]},a.id))}):e.jsx("p",{className:s("text-center py-8",t.text.tertiary),children:"No documents uploaded"})}),y==="questionnaire"&&e.jsxs("div",{className:"p-6 space-y-8",children:[o.map(a=>{const r=H[a.id],n=r.max>0?r.total/r.max*100:0;return e.jsxs("div",{className:s("border rounded-lg p-6",t.border.primary),children:[e.jsxs("div",{className:"flex items-start justify-between mb-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:s("text-lg font-semibold",t.text.primary),children:a.name}),a.description&&e.jsx("p",{className:s("text-sm mt-1",t.text.secondary),children:a.description})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-2xl font-bold text-blue-600 dark:text-blue-400",children:r.total.toFixed(2)}),e.jsxs("p",{className:s("text-sm",t.text.secondary),children:["/ ",r.max.toFixed(2)]}),e.jsx("div",{className:s("mt-2 w-24 rounded-full h-2","bg-gray-200 dark:bg-slate-700"),children:e.jsx("div",{className:"bg-blue-600 dark:bg-blue-500 h-2 rounded-full",style:{width:`${Math.min(n,100)}%`}})})]})]}),e.jsx("div",{className:"space-y-6",children:a.items.map(l=>e.jsxs("div",{className:s("border-t pt-6","border-gray-100 dark:border-slate-700"),children:[e.jsxs("div",{className:"mb-4",children:[e.jsxs("p",{className:s("text-sm font-medium",t.text.primary),children:[l.number,". ",l.question]}),e.jsxs("p",{className:s("text-xs mt-1",t.text.tertiary),children:["Max: ",l.max_score.toFixed(2)]})]}),e.jsx("div",{className:"flex gap-3 mb-4",children:l.score_options&&l.score_options.length>0&&Array.from(new Set(l.score_options)).sort((c,p)=>c-p).slice(0,3).map((c,p)=>{const f=se(c,l.score_options);return e.jsxs("div",{className:"relative",children:[e.jsx("button",{onClick:()=>V(l.id,c),disabled:x,className:`px-4 py-2 rounded-lg font-medium transition-all ${j[l.id]===c?s("text-white",t.button.primary):s("text-gray-700 dark:text-gray-300","bg-gray-100 dark:bg-slate-700 hover:bg-gray-200 dark:hover:bg-slate-600")} ${x?"opacity-50 cursor-not-allowed":""}`,title:`${f} (${c})`,children:f}),e.jsx("span",{className:"absolute -top-8 left-1/2 transform -translate-x-1/2 bg-gray-800 dark:bg-gray-700 text-white text-xs rounded px-2 py-1 opacity-0 hover:opacity-100 transition-opacity whitespace-nowrap",children:c})]},`item-${l.id}-score-${c}`)})}),e.jsxs("div",{children:[e.jsx("label",{className:s("block text-sm font-medium mb-2",t.text.primary),children:"Remarks"}),e.jsx("textarea",{value:w[l.id]||"",onChange:c=>z(l.id,c.target.value),disabled:x,placeholder:"Add remarks for this item...",className:s("w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500",t.input.base,`${x?"bg-gray-50 dark:bg-slate-700/50 cursor-not-allowed opacity-50":""}`),rows:2})]})]},l.id))})]},a.id)}),e.jsxs("div",{className:s("border-t-2 pt-8","border-gray-300 dark:border-slate-700"),children:[e.jsx("label",{className:s("block text-lg font-semibold mb-4",t.text.primary),children:"Final Remarks"}),e.jsx("textarea",{value:_,onChange:a=>{x||L(a.target.value)},disabled:x,placeholder:"Enter your final remarks for this evaluation...",className:s("w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",t.input.base,`${x?"bg-gray-50 dark:bg-slate-700/50 cursor-not-allowed opacity-50":""}`),rows:4}),!x&&e.jsxs("div",{className:"mt-4",children:[e.jsx("label",{className:s("block text-sm font-medium mb-2",t.text.tertiary),children:"Final Action"}),e.jsxs("select",{value:A,onChange:a=>P(a.target.value),className:s("px-3 py-2 rounded-lg",t.input.base),children:[e.jsx("option",{value:"approve",children:"Approve"}),e.jsx("option",{value:"revision",children:"For Revision"}),e.jsx("option",{value:"decline",children:"Decline"})]})]})]})]}),y==="result"&&e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{className:s("border rounded-lg p-6",t.border.primary,"bg-blue-50 dark:bg-blue-900/30"),children:[e.jsx("p",{className:s("text-sm font-medium mb-2",t.text.tertiary),children:"Total Score"}),e.jsxs("div",{className:"flex items-baseline gap-4",children:[e.jsx("p",{className:"text-4xl font-bold text-blue-600 dark:text-blue-400",children:N.toFixed(2)}),v&&e.jsxs("div",{children:[e.jsx("p",{className:s("font-semibold text-lg",t.text.primary),children:v.interpretation}),e.jsx("p",{className:s("text-sm mt-1",t.text.secondary),children:v.description})]})]})]}),h.length>0&&e.jsxs("div",{className:s("border rounded-lg p-6",t.border.primary),children:[e.jsx("p",{className:s("text-sm font-medium mb-4",t.text.tertiary),children:"Scoring Reference"}),e.jsx("div",{className:"space-y-3",children:h.map((a,r)=>e.jsxs("div",{className:s("flex items-center justify-between p-3 rounded","bg-gray-50 dark:bg-slate-700/50"),children:[e.jsxs("div",{children:[e.jsx("p",{className:s("font-medium",t.text.primary),children:a.interpretation}),e.jsx("p",{className:s("text-sm",t.text.secondary),children:a.description})]}),e.jsxs("p",{className:s("font-mono text-sm font-semibold",t.text.tertiary),children:[a.min," - ",a.max]})]},r))})]}),e.jsxs("div",{className:s("border rounded-lg p-6",t.border.primary),children:[e.jsx("p",{className:s("text-sm font-medium mb-3",t.text.tertiary),children:"Final Remarks"}),e.jsx("div",{className:s("p-4 rounded-lg","bg-gray-50 dark:bg-slate-700/50"),children:d.final_remarks?e.jsx("p",{className:s("whitespace-pre-wrap",t.text.primary),children:d.final_remarks}):e.jsx("p",{className:s("italic",t.text.tertiary),children:"No remarks provided"})})]}),d.is_completed&&e.jsxs("div",{className:s("border rounded-lg p-6","bg-green-50 dark:bg-green-900/30 border-green-200 dark:border-green-800"),children:[e.jsx("p",{className:s("font-semibold mb-2","text-green-900 dark:text-green-100"),children:"✓ Evaluation Submitted"}),d.completion_date&&e.jsxs("p",{className:s("text-sm","text-green-800 dark:text-green-100"),children:["Submitted on: ",new Date(d.completion_date).toLocaleString()]})]})]})]}),x?e.jsx("div",{className:s("mt-6 border-2 rounded-lg p-6","bg-green-50 dark:bg-green-900/40 border-green-200 dark:border-green-700"),children:e.jsxs("div",{className:"flex items-start gap-4",children:[e.jsx("div",{className:"bg-green-600 dark:bg-green-500 rounded-lg p-3 flex-shrink-0",children:e.jsx(K,{className:"w-6 h-6 text-white"})}),e.jsxs("div",{children:[e.jsx("h3",{className:s("font-semibold text-lg","text-green-900 dark:text-green-100"),children:"✓ Evaluation Submitted"}),e.jsx("p",{className:s("mt-2","text-green-800 dark:text-green-100"),children:"This evaluation has been completed and can no longer be modified. All data has been locked for data integrity."}),d.completion_date&&e.jsxs("p",{className:s("text-sm mt-2","text-green-700 dark:text-green-200"),children:["Submitted on: ",new Date(d.completion_date).toLocaleString()]})]})]})}):e.jsxs("div",{className:"mt-6 flex gap-4 justify-end",children:[e.jsxs("button",{onClick:I,disabled:S||C,className:s("flex items-center gap-2 px-6 py-3 border rounded-lg transition-colors disabled:opacity-50",t.border.primary,t.text.primary,"hover:bg-gray-100 dark:hover:bg-slate-700"),children:[e.jsx(ee,{className:"w-5 h-5"}),S?"Saving...":"Save Progress"]}),e.jsxs("button",{onClick:O,disabled:S||C,className:s("flex items-center gap-2 px-6 py-3 text-white rounded-lg transition-colors disabled:opacity-50",t.button.primary),children:[e.jsx(X,{className:"w-5 h-5"}),C?"Submitting...":"Submit Evaluation"]})]})]})})]})}export{fe as default};
